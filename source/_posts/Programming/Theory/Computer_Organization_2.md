---
title: 计算机组成原理（2）：计算机系统的硬件结构
categories:
  - Programming
  - Theory
comments: true
description: 计算机组成原理第二部分：计算机系统的硬件结构
series: 计算机组成原理笔记
hide: true
mathjax: false
katex: true
highlight_shrink: true
cover: /img/posts/计算机组成原理.png
abbrlink: a7cddde5
date: 2025-12-20 00:00:00
updated: 2025-12-20 00:00:00
keywords:
top_img:
aside:
aplayer:
---

## 第3章 系统总线

本章重点介绍计算机各部件如何连接在一起，以及它们之间如何协调通信。

### 3.1 总线的基本概念

**1. 为什么要用总线？**
*   **分散连接（早期方式）**：各部件之间两两用单独的线连接。
    *   *缺点*：连线极其复杂。如果想加一个新的I/O设备（比如打印机），很难连接，因为原来的线是固定的。且早期结构以运算器为中心，I/O传输数据时会打断CPU运算。
*   **总线连接（现代方式）**：将各部件连到一组**公共**的信息传输线上。
    *   *优点*：结构清晰，扩展性好（想加设备直接挂在总线上即可）。

**2. 什么是总线？**
*   **定义**：总线是连接多个部件的信息传输线，是各部件**共享**的传输介质。
*   **核心规则**：
    *   **发送**：在某一个时刻，**只允许有一个**部件向总线发送信息（否则信号会冲突）。
    *   **接收**：多个部件可以同时从总线上接收相同的信息。
*   **物理形态**：总线由许多传输线组成。16条传输线就可以同时传输16位二进制代码（并行传输）。

**3. 总线结构的演变**
*   **面向CPU的双总线结构**：
    *   **M总线**：连接CPU和主存。
    *   **I/O总线**：连接CPU和I/O设备。
    *   *缺点*：I/O设备和主存交换数据必须经过CPU，CPU成了“搬运工”，效率低。

![图 3.1 面向CPU的双总线结构框图](/img/post_article/计算机组成原理/3-1.png)

>   *   **描述**：CPU处于顶端，向左下方伸出一组“M总线”连接主存，向右下方伸出一组“I/O总线”连接多个I/O接口。I/O设备挂在接口下方。

*   **单总线结构**：
    *   CPU、主存、I/O设备都挂在同一组总线上。
    *   *优点*：I/O设备和主存可以直接交换信息，不需要CPU干预（前提是支持DMA）。
    *   *缺点*：只有一条路，大家都要走，容易堵车（争用总线）。

![图 3.2 单总线结构框图](/img/post_article/计算机组成原理/3-2.png)

> *   **描述**：一条横向的“单总线（系统总线）”。CPU、主存、I/O接口都并排挂在这条线上。

*   **以存储器为中心的双总线结构**：
    *   在单总线基础上，在CPU和主存之间单独开辟一条“**存储总线**”。
    *   *优点*：CPU读写内存时不占用系统总线，减轻了负担，速度更快。

![图 3.3 以存储器为中心的双总线结构框图](/img/post_article/计算机组成原理/3-3.png)

> *   **描述**：主存位于中心位置。左边通过“存储总线”单独连CPU，上方通过“系统总线”连各种I/O接口。

### 3.2 总线的分类

按连接部件不同，分为三类：

#### 3.2.1 片内总线

*   **定义**：指**芯片内部**的总线。
*   **位置**：在CPU芯片里面，连接寄存器与寄存器、寄存器与ALU（算术逻辑单元）。

#### 3.2.2 系统总线

*   **定义**：连接CPU、主存、I/O设备各大部件之间的信息传输线。通常指计算机主板上的总线（板级总线）。
*   **按传输内容分类**（非常重要）：
    1.  **数据总线 (Data Bus)**：
        *   **作用**：传输数据信息。
        *   **方向**：**双向**传输（CPU既要读数据也要写数据）。
        *   **位数**：称为**数据总线宽度**。通常与机器字长或存储字长有关（如32位、64位）。它是衡量系统性能的重要参数。
    2.  **地址总线 (Address Bus)**：
        *   **作用**：指出数据在哪里（源地址或目的地址）。
        *   **方向**：**单向**传输（由CPU发出，指向存储器或I/O端口）。
        *   **位数**：决定了**寻址能力**。例如20根地址线，能访问 $2^{20} = 1\text{M}$ 个单元。
    3.  **控制总线 (Control Bus)**：
        *   **作用**：发出各种控制信号，协调各部件工作。
        *   **方向**：对单根线通常是单向的，但作为整体是**双向**的（既有CPU发出的命令，也有设备反馈的状态）。
        *   **信号举例**：时钟、复位、总线请求、总线允许、存储器读/写、中断请求等。

#### 3.2.3 通信总线

*   **定义**：用于计算机系统之间，或计算机与其他系统（如仪表）之间的通信。
*   **按传输方式分类**：
    1.  **串行通信**：
        *   **特点**：数据在单条线上，一位一位地按顺序传送。
        *   **适用**：远距离传输（省线、省钱）。
    2.  **并行通信**：
        *   **特点**：数据在多条线上同时传送（如8位一起传）。
        *   **适用**：近距离传输（速度快，但线多、贵，且距离远了容易产生干扰）。

### 3.3 总线特性及性能指标

#### 3.3.1 总线特性

为了让不同厂家的板卡能插在一起工作，总线必须有统一的特性：
1.  **机械特性**：插头、插座的尺寸、形状、引脚排列顺序。（物理尺寸）
2.  **电气特性**：传输线上信号的传递方向 和有效的 电平 范围。
    *   输出信号：CPU发出的信号。
    *   输入信号：输入CPU的信号。
        *   地址总线：单向输出线，高电平为1，低电平为0。
        *   数据总线：双向传输线，高电平为1，低电平为0。
        *   控制总线：每一个为单向，但整体有输入和输出，高电平/低电平有效。
3.  **功能特性**：每根传输线的功能。
    *   地址总线：传输地址码。
    *   数据总线：传输数据信息。
    *   控制总线：传输控制信号。
4.  **时间特性**：总线上的各种信号间的**时序**关系：总线中的任一根线在什么时间内有效。

![图 3.3 总线结构的物理实现](/img/post_article/计算机组成原理/3-3.png)

> *   **描述**：展示了主板（底板）上有许多平行的插槽，CPU插板、主存插板、I/O插板都垂直插入这些槽中。插槽背后的印刷电路连线就是总线。

#### 3.3.2 总线性能指标

1.  **总线宽度**：数据总线的根数（位宽）。如32位、64位。
2.  **总线带宽**：**单位时间内**总线上传输数据的位数。通常用MBps（兆字节每秒）表示。
    *   **公式**：$\text{总线带宽} = \text{总线工作频率} \times (\text{总线宽度}/8)$。
3.  **时钟同步/异步**：
    *   **同步总线**：数据传输跟着统一的时钟节奏走。
    *   **异步总线**：没有统一时钟，靠互相发信号来协调。
4.  **总线复用**：一条信号线上分时传送两种信号（如地址线和数据线共用物理线路，先传地址，后传数据），为了减少引脚数。
5.  **信号线数**：地址线、数据线、控制线总和。
6.  **总线控制方式**：突发工作、自动配置、仲裁方式等。
7.  **负载能力**：总线能驱动多少个设备。

#### 3.3.3 总线标准

*   **概念**：所谓总线标准，就是一套大家公认的连接规则。只要按标准设计，不同厂家的显卡、网卡都能插在同一块主板上。
*   **常见的总线标准**：
    1.  **ISA 总线**：早期标准，16位，速度慢，CPU要亲自参与控制，效率低。
    2.  **EISA 总线**：ISA的扩展，32位，兼容ISA。
    3.  **VESA (VL-BUS) 总线**：局部总线标准，直接挂在CPU上，速度快，主要用于早期的显卡。但负载能力差（只能挂一两个设备）。
    4.  **PCI 总线**（重要）：
        *   不依附于具体处理器的局部总线。
        *   有**PCI桥**（控制器）作为中间层，将高速设备和CPU隔开，互不干扰。
        *   支持**即插即用** (Plug and Play)。
        *   支持**突发工作**方式（给一次地址，传一堆数据）。
    5.  **AGP 总线**：专门为了解决3D图形数据量大、PCI带宽不够的问题而设计的**显卡专用接口**。
    6.  **RS-232C 总线**：串行通信接口标准。
        *   用于连接“数据终端设备(DTE)”和“数据通信设备(DCE，如调制解调器)”。
        *   *注意*：它的电平标准和计算机内部（TTL）不一样，连接时需要电平转换。
    7.  **USB 总线** (通用串行总线)：
        *   **特点**：即插即用、支持热插拔（不关机就能插拔）、连接能力强（通过集线器HUB可以连127个设备）。
        *   **供电**：线缆中包含电源线，可直接对外设供电。
        *   **结构**：通过HUB形成树状/星型结构。

### 3.4 总线结构

随着速度要求提高，总线结构越来越复杂。

#### 3.4.1 单总线结构

*   将计算机当中的所有部件都连接到一组总线（系统总线）上。
*   缺点：任何时刻只能有一个部件占用总线，总线成为系统的性能瓶颈。

#### 3.4.2 多总线结构

1.  **以CPU为中心的双总线结构**：
    *   存储总线（M总线）：连接CPU和主存。
    *   输入输出总线（I/O总线）：连接CPU和各I/O设备。
    *   CPU和主存间有专用的M总线，有利于提高CPU的工作效率。
    *   缺点：I/O设备在与主存交换信息时，需占用CPU。

![图 3.6 以CPU为中心的双总线结构](/img/post_article/计算机组成原理/3-6.png)

2.  **以存储器为中心的双总线结构**：
    *   I/O设备与主存交换信息时，无需经过CPU。

![图 3.7 以存储器为中心的双总线结构](/img/post_article/计算机组成原理/3-7.png)

3.  **三总线结构**：
    *   双总线结构高速外设和低速外设共用总线，会影响其工作效率。
    *   **主存总线**：CPU和主存之间。
    *   **I/O总线**：CPU和I/O设备之间。
    *   **DMA（直接存储器访问）总线**：内存和高速I/O设备（如磁盘）之间直接交换数据。高速外设可通过DMA总线直接与主存进行信息交换。
    *   *特点*：任一时刻只能使用一种总线。
    *   以CPU为中心：低速外设需通过CPU才能与主存进行信息交换。

![图 3.8 三总线结构](/img/post_article/计算机组成原理/3-8.png)

4.  **三总线结构的又一形式（带Cache）**：
    *   **局部总线**：连接CPU和Cache（高速缓存）。
    *   **系统总线**：连接Cache和主存。
    *   **扩展总线**：连接各种外部设备（如Modem、串口、局域网）。
5.  **四总线结构**：
    *   在上面的基础上，增加了一条**高速总线**，专门挂接高速设备（如高速局域网、图形工作站、多媒体）。
    *   低速设备（如传真、打印机）依然挂在扩展总线上。

#### 3.4.3 总线结构举例

*   **传统微型机**：ISA总线。
*   **VL-BUS结构**：引入了局部总线，显卡直接连CPU端。
*   **PCI总线结构**：
    *   CPU通过**PCI桥**（桥接芯片）连接PCI总线。
    *   PCI总线上挂接高速设备。
    *   PCI总线还可以通过桥接器再连接ISA/EISA总线（挂低速设备）。
    *   *优点*：CPU和PCI设备并行工作，且支持多层结构（桥连桥）。

![图 3.14 多层PCI总线结构](/img/post_article/计算机组成原理/3-14.png)

> *   **描述**：通过第一级桥、第二级桥层层扩展，每一层都可以挂设备，扩展能力很强。

### 3.5 总线控制

总线是共享资源，大家都要用，谁先用？怎么用？这就需要总线控制。主要包括**判优控制**（决定谁用）和**通信控制**（决定怎么传）。

#### 3.5.1 总线判优控制

解决多个设备同时争用总线的问题。分为**主设备**（有权发起控制）和**从设备**（只能被动响应）。

**1. 集中式控制**（控制逻辑集中在CPU或总线控制器中）：
*   **(1) 链式查询**：
    *   **原理**：控制信号（总线允许BG）像一条链子一样，从第一个设备传到第二个，再传到第三个……
    *   **优先级**：离控制器越近，优先级越高。
    *   *优点*：结构极简单，线少。
    *   *缺点*：对电路故障敏感（如果第1个设备坏了，后面的都收不到信号，全瘫痪）；优先级固定，不灵活。
*   **(2) 计数器定时查询**：
    *   **原理**：总线控制器里有个计数器，按数字（设备地址）喊号。喊到谁，谁就用。
    *   *优点*：优先级可以改变（通过改变计数器的初始值或计数顺序）。
    *   *缺点*：线比链式多一点。
*   **(3) 独立请求方式**：
    *   **原理**：每个设备都单独拉两根线（请求线BR、允许线BG）直接连到控制器。
    *   *优点*：响应速度最快，优先级控制最灵活。
    *   *缺点*：线太多了，控制逻辑复杂。

![图 3.15 集中控制的三种优先权仲裁方式](/img/post_article/计算机组成原理/3-15.png)

**2. 分布式控制**：
*   不需要中央控制器，每个设备都有逻辑电路，通过比对优先级号自行决定谁用总线。

#### 3.5.2 总线通信控制

解决通信双方如何协调时间、配合动作的问题。总线传输周期通常分为：**申请分配** -> **寻址** -> **传数** -> **结束**。

**四种通信方式：**

**1. 同步通信**
*   **原理**：统一的时间标准。在固定的时间点做固定的事。
*   *优点*：速度快，控制简单。
*   *缺点*：必须迁就速度最慢的设备（强制同步），灵活性差。

![图 3.16 同步式数据输入传输](/img/post_article/计算机组成原理/3-16.png)

> *   **描述**：有一个统一的时钟脉冲信号。T1时刻发地址，T2时刻发命令...所有动作严格对齐时钟边缘。

**2. 异步通信**
*   **原理**：没有公共时钟，采用**应答方式**（握手）。
    *   主设备：我发出请求了！
    *   从设备：我收到了！
    *   主设备：那我撤销请求了。
*   **三种握手类型**：
    *   **(1) 不互锁**：主发请求，不等回答直接撤销；从发回答，不等主撤销直接撤销。（最不可靠）
    *   **(2) 半互锁**：主发请求，必须等回答才撤销；从发回答后自动撤销。（主锁从不锁）
    *   **(3) 全互锁**：主发请求，等回答才撤销；从发回答，等主撤销请求后，它才撤销回答。（最可靠，最严谨）。
*   *优点*：灵活，允许速度差异很大的设备通信。

**3. 半同步通信**
*   **原理**：保留同步时钟，但增加一条“**等待 (WAIT)**”信号线。
*   *应用*：当从设备速度跟不上时，拉低WAIT信号，主设备检测到后就“等”它几个周期，直到WAIT信号取消。
*   *特点*：结合了同步的效率和异步的灵活性。

**4. 分离式通信**
*   **原理**：将一个传输周期分成两个子周期。
    1.  **子周期1**：主设备发命令和地址，然后**立即放弃**总线。
    2.  **空闲期**：从设备在内部准备数据，总线可以让给别人用。
    3.  **子周期2**：从设备准备好数据后，申请总线，把数据传回给主设备。
*   *优点*：总线利用率极高，挖掘了总线潜力。
*   *特点*：只有单方向的信息流，每个模块都变成了主模块。

## 第4章 存储器

本章主要介绍存储器的分类、工作原理、主存的组成、Cache以及辅助存储器。核心在于理解存储系统的**层次结构**（Cache-主存-辅存）。

### 4.1 概述

#### 4.1.1 存储器分类

存储器是计算机的记忆设备。由于CPU速度极快而存储器速度相对较慢，存储器往往成为系统瓶颈。

**1. 按存储介质分类**
*   **半导体存储器**：
    *   **材料**：TTL（双极型，速度快但功耗大）、MOS（集成度高，功耗小，主流）。
    *   **特点**：体积小、速度快。
    *   **缺点**：**易失性**，断电后信息丢失（除了现在的Flash等非易失技术）。
*   **磁表面存储器**：
    *   **载体**：磁盘、磁带。
    *   **原理**：在金属或塑料基体上涂磁性材料，靠磁头读写。
    *   **特点**：**非易失性**，断电信息不丢。
*   **光盘存储器**：利用激光读写，非易失。

**2. 按存取方式分类**
*   **随机存储器 (RAM)**：
    *   **定义**：任何一个单元的内容都可以随机存取，存取时间与物理位置**无关**。
    *   **应用**：主存。
*   **只读存储器 (ROM)**：
    *   **定义**：只能读出，不能写入（或只能用特殊方法写入）。
    *   **应用**：存放固定不变的程序（如BIOS）。
*   **串行访问存储器**：
    *   **定义**：读写时需要按物理位置先后顺序寻找。
    *   **顺序存取存储器**：如磁带，必须从头走到尾。
    *   **直接存取存储器**：如磁盘，先直接跳到某个区域（磁道），再在区域内顺序寻找。

**3. 按在计算机中的作用分类**
*   **主存储器（主存）**：可以和CPU**直接**交换信息。速度快，容量小。
*   **辅助存储器（辅存/外存）**：主存的后援，存放暂时不用的数据。**不能**直接和CPU交换信息，必须调入主存。速度慢，容量大。
*   **缓冲存储器（缓存/Cache）**：用在两个速度不同的部件之间（如CPU和主存），起缓冲作用。

![图 4.1 存储器分类](/img/post_article/计算机组成原理/4-1.png)

> *   **描述**：展示了存储器的分类树状图。主存包括RAM（静态、动态）和ROM（MROM, PROM, EPROM, EEPROM）。辅存包括磁盘、磁带、光盘。

#### 4.1.2 存储器的层次结构

存储器有三个核心指标：**速度、容量、位价**（每位价格）。
*   **矛盾**：速度越快，价格越高，容量往往越小。
*   **解决**：采用多级层次结构。

![图 4.2 存储器速度、容量和位价的关系](/img/post_article/计算机组成原理/4-2.png)

> *   **描述**：一个金字塔结构。塔尖是寄存器（最快、最贵、最小），塔底是磁带（最慢、最便宜、最大）。

**存储系统的缓存、主存、辅存层次：**
1.  **缓存-主存层次**：
    *   **目的**：解决**CPU和主存速度不匹配**的问题。
    *   **原理**：利用Cache（高速小容量）存放CPU近期要用的数据。
    *   **透明性**：对程序员透明（自动完成），数据调动由**硬件**完成。
2.  **主存-辅存层次**：
    *   **目的**：解决**存储容量**的问题。
    *   **原理**：利用辅存（低速大容量）存放大量数据，用时调入主存。
    *   **透明性**：数据调动由**硬件和操作系统**共同完成。由此形成了**虚拟存储器**的概念（让程序员觉得内存无穷大）。

### 4.2 主存储器

#### 4.2.1 概述

主存由存储体、驱动器、译码器、读写电路等组成。
*   **MAR和MDR逻辑上属于主存，物理上制作在CPU芯片内。**

![图 4.4 主存的基本组成](/img/post_article/计算机组成原理/4-4.png)

> *   **描述**：MAR（地址寄存器）接收地址 -> 译码器/驱动器找到单元 -> 存储体 -> 读写电路 -> MDR（数据寄存器）输出数据。

*   **主存与CPU的联系**：
    *   CPU通过**地址总线**发地址给MAR。
    *   CPU通过**数据总线**与MDR交换数据。
    *   CPU通过**控制总线**发读/写命令。

![图 4.5 主存和CPU的联系](/img/post_article/计算机组成原理/4-5.png)

> *   **描述**：CPU和主存之间通过三组线（MDR连数据线，MAR连地址线，CPU发读写信号）连接。

*   **主存中存储单元地址的分配**：
    *   **大端模式 (Big-Endian)**：高位字节排在低地址（符合人类阅读习惯）。
    *   **小端模式 (Little-Endian)**：低位字节排在低地址。
    *   *注意*：寻址范围取决于地址线位数。例如24位地址线，按字节寻址范围是 $2^{24}=16\text{M}$。

*   **主存的技术指标**：
    1.  **存储容量**：存储单元个数 $\times$ 存储字长。
    2.  **存储速度**：
        *   **存取时间**：启动一次操作到完成的时间。
        *   **存取周期**：连续两次独立操作所需的**最小间隔时间**。（周期 > 时间，因为读写后电路需要一段恢复时间）。
    3.  **存储器带宽**：单位时间内存储器存取的信息量（位/秒或字节/秒）。

#### 4.2.2 半导体存储芯片简介

**1. 基本结构**
![图 4.7 存储芯片的基本结构](/img/post_article/计算机组成原理/4-7.png)

*   **译码驱动**：把地址变成选择信号，选中某个存储单元。
*   **存储矩阵**：存放0/1的阵列。
*   **读写电路**：完成读写操作。
*   **引脚**：地址线（单向）、数据线（双向）、控制线（片选CS、读写WE）。
    *   **地址线**：单向输入，其位数与芯片容量有关。
    *   **数据线**：双向，其位数与芯片可读出或写入的数据位数有关。数据线的位数与芯片容量有关。
    *   **地址线和数据线的位数共同反映存储芯片的容量**：例如，地址线10根，数据线4根，则芯片容量为 $2^{10} \times 4 = 4K$ 位。
    *   **读/写控制线**：决定芯片进行读/写操作。
        *  一根线
            $\overline{WE}$: 低电平写，高电平读
        *  两根线
            $\overline{OE}$: 低电平有效，允许读
            $\overline{WE}$: 低电平有效，允许写
 
    *   **片选线 (CS/CE)**：Chip Select，用来选择存储芯片。低电平有效时，芯片才工作。这是**扩展存储器**的关键。
        *  芯片选择线：选择存储芯片
        *  标识方式
            $\overline{CS}$: 芯片选择，低电平有效
            $\overline{CE}$: 芯片使能，低电平有效


**2. 译码驱动方式**
*   **线选法**：
    *   一根字线选中一个字的所有位。
    *   *缺点*：地址线多时，字线太多，芯片很难设计。适合小容量。

![图 4.9 16×1字节线选法结构示意图](/img/post_article/计算机组成原理/4-9.png)

*   **重合法**：
    *   将地址分为**行地址**和**列地址**。
    *   行、列交叉点才是选中的单元。
    *   *优点*：大大减少了选择线的数量。适合大容量。

![图 4.10 1K×1位重合法结构示意图](/img/post_article/计算机组成原理/4-10.png)

*   **重合法 VS 线选法**：
    *   假设存储器容量为1M × 8位，需要怎样的地址译码器？
    *   线选法
        * 输入：20条地址线，输出：1M条线
        * 需要的输出线数过大，集成度低，只适用于小容量的存储芯片
    *   重合法
        * 用8个1M × 1位存储芯片构成
        * 行地址：输入：10条行地址线，输出：1K条线
        * 列地址：输入：10条列地址线，输出：1K条线
        * 集成度高，适用于大容量芯片


#### 4.2.3 随机存取存储器 (RAM)

随机存取存储器（RAM）根据存储信息的原理不同，分为静态RAM（SRAM）和动态RAM（DRAM）。

**1. 静态 RAM (Static RAM, SRAM)**
*   **存储原理**：利用**触发器**（双稳态电路）来存储“0”和“1”。
*   **基本单元**：通常由6个MOS管组成。
    *   *理解*：触发器就像一个开关，拨上去是1，拨下来是0，只要不断电，它就一直保持在这个状态，非常稳定。
*   **特点**：
    *   **速度快**：不需要刷新，读写速度非常快。
    *   **集成度低**：一个存储位需要6个晶体管，占用硅片面积大。
    *   **功耗大**：电路一直处于导通状态。
    *   **价格贵**。
    *   **易失性**：断电后信息丢失。
*   **应用**：通常用作**高速缓冲存储器 (Cache)**。
*   **读/写时序**：
    *   **读周期**：地址有效 -> 片选有效 -> 数据输出。
    *   **写周期**：地址有效 -> 片选有效 -> 写命令有效 -> 数据输入。

**2. 动态 RAM (Dynamic RAM, DRAM)**
*   **存储原理**：利用**电容**存储电荷的原理来寄存信息。
    *   电容上有电荷代表“1”，无电荷代表“0”。
*   **基本单元**：常见的有三管式和单管式（1个MOS管+1个电容）。
    *   *理解*：就像一个小水桶，有水是1，没水是0。
*   **特点**：
    *   **集成度高**：结构简单，体积小。
    *   **功耗低**。
    *   **价格便宜**。
    *   **速度较慢**。
    *   **需要刷新**：这是DRAM最大的特点。
        *   *理解*：因为电容（水桶）会漏电（漏水），时间长了“1”就变成了“0”，所以必须每隔一段时间给它充电（加水），这叫“刷新”。
*   **应用**：通常用作**主存储器（内存）**。

**3. DRAM的刷新**
刷新本质上是**先读出，再写入**（再生）的过程。刷新是按**行**进行的。
常见的刷新方式有三种：
*   **(1) 集中刷新**：
    *   **原理**：在规定的刷新周期（如2ms）内，拿出一言段时间，把所有行全部刷新一遍。
    *   **死区**：在刷新期间，CPU无法访问存储器，这段时间称为“死时间”或“访存死区”。
    *   *理解*：像商店每天专门停业一小时来盘点货物，这期间顾客不能买东西。
*   **(2) 分散刷新**：
    *   **原理**：把存取周期加长（如翻倍）。前半段用来正常读写，后半段用来刷新某一行。
    *   **特点**：没有死区，但存取周期变长了，整个系统速度变慢。
    *   *理解*：像商店每卖一件货，就强制盘点一下库存，效率低。
*   **(3) 异步刷新**（最常用）：
    *   **原理**：结合了前两者。将刷新任务平均分配到整个刷新周期（2ms）内。假设有128行，2ms内要刷完，那么每隔 $2ms \div 128 \approx 15.6\mu s$ 刷新一行。
    *   **特点**：既没有长时间的死区，又不拖慢每个存取周期。
    *   *理解*：利用CPU不访问内存的间隙（比如译码阶段）偷偷刷新一行，既不耽误事，也能完成任务。

#### 4.2.4 只读存储器 (ROM)

ROM的发展经历了几个阶段：
1.  **掩模 ROM (MROM)**：厂家出厂时写死，用户无法修改。
2.  **PROM (Programmable ROM)**：一次性编程。用户可以用专门设备写一次，写坏了就废了（熔丝原理）。
3.  **EPROM (Erasable PROM)**：可擦除。用**紫外线**照射擦除，可以重写多次。
4.  **EEPROM (E-squared PROM)**：**电**可擦除。不需要紫外线，直接电信号擦除重写。
5.  **Flash Memory (闪存)**：基于EEPROM技术，具备RAM功能。**整块**擦除，速度快，集成度高。如U盘、SSD。

#### 4.2.5 存储器与 CPU 的连接

单块芯片容量不够，需要将多块芯片连起来组成大内存。

**1. 容量扩展（三种方式）**
*   **位扩展**（增加字长）：
    *   *场景*：芯片只有1位或4位，但CPU需要8位或16位数据。
    *   *连法*：**地址线并联**（都接一样的），**数据线分别**接到CPU数据总线的不同位，**片选线并联**（同时工作）。

![图 4.33 由8片16K×1位的芯片组成16K×8位的存储器](/img/post_article/计算机组成原理/4-33.png)

*   **字扩展**（增加字数/容量）：
    *   *场景*：芯片只有1K容量，但需要16K容量。
    *   *连法*：**地址线低位并联**，**数据线并联**。**地址线高位**通过译码器分别接各芯片的**片选线**（CS）。

![图 4.34 由2片1K×8位的芯片组成2K×8位的存储器](/img/post_article/计算机组成原理/4-34.png)

*   **字、位同时扩展**：既增加位数，又增加容量。先位扩展组成一组，再字扩展连接多组。

![图 4.35 由8片1K×4位的芯片组成4K×8位的存储器](/img/post_article/计算机组成原理/4-35.png)

**2. 连接步骤**
1.  **地址线**：CPU低位对芯片低位，高位用于片选译码。
2.  **数据线**：位数匹配。
3.  **读/写命令线**：直接连接。
4.  **片选线**：这是核心。利用高位地址经过**译码器**（如74138）产生片选信号，保证任何时候只选中一组芯片。

这里使用**原书例 4.2** 来详细说明如何进行存储器扩展和连接。

**题目要求：**
*   **CPU信号**：16根地址线 ($A_{15} \dots A_0$)，8根数据线 ($D_7 \dots D_0$)，MREQ（访存控制，低电平有效），WR（高读低写）。
*   **地址空间分配要求**：
    1.  **系统程序区**：最小8K地址范围 -> 选用 **ROM**。
    2.  **用户程序区**：与其相邻的16K地址范围 -> 选用 **RAM**。
    3.  **系统程序工作区**：最大4K地址范围 -> 选用 **RAM**。
*   **可用芯片**：8K×8位 ROM，8K×8位 RAM，4K×8位 RAM，74138译码器等。

**解题步骤详解：**

**(1) 写出二进制地址码（确定地址范围）**
地址线16根，总寻址范围64K。
*   **最小8K (0 ~ 8K-1)**：
    *   二进制：0000 0000 0000 0000 ~ 0001 1111 1111 1111
    *   十六进制：`0000H` ~ `1FFFH`
    *   高3位 ($A_{15}A_{14}A_{13}$) 为 `000`。
*   **相邻16K (8K ~ 24K-1)**：
    *   因为现有芯片最大是8K，所以16K需要两片8K芯片。
    *   **第一片8K (8K ~ 16K-1)**：
        *   二进制：0010 0000 0000 0000 ~ 0011 1111 1111 1111
        *   十六进制：`2000H` ~ `3FFFH`
        *   高3位 ($A_{15}A_{14}A_{13}$) 为 `001`。
    *   **第二片8K (16K ~ 24K-1)**：
        *   二进制：0100 0000 0000 0000 ~ 0101 1111 1111 1111
        *   十六进制：`4000H` ~ `5FFFH`
        *   高3位 ($A_{15}A_{14}A_{13}$) 为 `010`。
*   **最大4K (60K ~ 64K-1)**：
    *   二进制：1111 0000 0000 0000 ~ 1111 1111 1111 1111
    *   十六进制：`F000H` ~ `FFFFH`
    *   高3位 ($A_{15}A_{14}A_{13}$) 为 `111`。

**(2) 确定芯片数量**
*   系统程序区 (8K)：选 **1片** 8K×8位 ROM。
*   用户程序区 (16K)：选 **2片** 8K×8位 RAM。
*   系统工作区 (4K)：选 **1片** 4K×8位 RAM。

**(3) 构造片选逻辑 (画图核心)**
利用74138译码器（3-8译码器）来控制片选信号。
*   **输入**：将CPU的高3位地址 $A_{15}, A_{14}, A_{13}$ 接到74138的输入端 C, B, A。
*   **控制端**：74138的使能端 $G_1$ 接+5V，$\bar{G}_{2A}$ 和 $\bar{G}_{2B}$ 接 MREQ（访存信号），保证只有访存时译码器才工作。
*   **输出（低电平有效）**：
    *   **$Y_0$ (`000`)**：选中 ROM (系统程序区)。
    *   **$Y_1$ (`001`)**：选中 RAM 1 (用户程序区前半段)。
    *   **$Y_2$ (`010`)**：选中 RAM 2 (用户程序区后半段)。
    *   **$Y_7$ (`111`)**：选中 RAM 3 (系统工作区)。
        *   *注意*：RAM 3是4K芯片，只需要12根地址线 ($A_{11} \dots A_0$)。但系统给了它最大4K的空间，所以这里 $A_{12}$ 必须为高电平。在连线时，$Y_7$ 输出后通常还要跟 $A_{12}$ 的逻辑配合（或者简单地将 $A_{12}$ 连到芯片地址线，虽然芯片只用12根，高位可忽略，视具体题目逻辑要求，本例中直接用 $Y_7$ 选通即可）。

![图 4.38 例4.2 CPU与存储芯片的连接图](/img/post_article/计算机组成原理/4-38.png)

> *   **标记**：图中展示了74138译码器的连接，以及各芯片地址线、数据线、读写线的连接方式。

#### 4.2.6 存储器的校验 (汉明码)

在计算机运行中，数据可能出错（如0变1）。汉明码是一种能够**纠正1位错误**，**检测2位错误**的编码。

**1. 汉明码的组成公式**
设 $n$ 为数据位的位数，$k$ 为检测位（校验位）的位数。必须满足以下关系：
$$ 2^k \ge n + k + 1 $$
*   *理解*：$k$ 位校验位能表示 $2^k$ 种状态。其中1种状态表示“全对”，剩下 $2^k-1$ 种状态要能覆盖 $n+k$ 个位置的每一位出错的情况。

**2. 检测位的位置**
检测位 $C_i$ 不是随便放的，必须安插在 $2^{i-1}$ 的位置上（即第1, 2, 4, 8...位）。
*   例如 $n=4$ (数据1100)，需要 $k=3$ ($2^3 \ge 4+3+1$)。
*   总长度7位。检测位在第1, 2, 4位。数据位在3, 5, 6, 7位。

**3. 汉明码的编码方法 (分组奇偶校验)**
*   每个检测位 $C_i$ 负责校验一组数据。
*   **分组规则**：将所有位置号（二进制）中，第 $i$ 位是1的归为一组，由 $C_i$ 负责。
    *   $C_1$ (位置1, `001`)：负责所有二进制最低位是1的位置（1, 3, 5, 7, 9...）
    *   $C_2$ (位置2, `010`)：负责所有二进制倒数第2位是1的位置（2, 3, 6, 7, 10...）
    *   $C_4$ (位置4, `100`)：负责所有二进制倒数第3位是1的位置（4, 5, 6, 7, 12...）
*   **计算值**：采用**异或**运算（偶校验），使该组内1的个数为偶数。

**4. 汉明码的纠错过程**
收到数据后，重新计算各组的校验值，得到一个新的 $k$ 位代码，称为**故障字**或**伴举症** ($P_k \dots P_2 P_1$)。
*   若 $P = 0$：无错。
*   若 $P \neq 0$：$P$ 的十进制数值就是**出错位的位号**。
    *   例如算出 $P_4 P_2 P_1 = 110$ (十进制6)，说明第6位出错了，直接对第6位取反（0变1，1变0）即可纠正。

#### 4.2.7 提高访存速度的措施

**1. 单体多字系统**
*   一次存取读出多个字（如4个字）。
*   *前提*：指令和数据在内存中是连续存放的。

**2. 多体并行系统**
*   **高位交叉编址（顺序存储）**：
    *   高位地址选模块。
    *   *效果*：仅仅是容量扩大，**不能**提高速度（因为程序通常顺序执行，会一直盯着一个模块访问）。
*   **低位交叉编址（交叉存储）**：
    *   低位地址选模块。例如：地址0在模块0，地址1在模块1...
    *   *效果*：**提高速度**。CPU可以轮流启动不同的模块（流水线方式），如果不冲突，存取周期近似缩短为 $1/n$。
    *   *公式*：设存取周期为 $T$，总线传输周期为 $\tau$，模块数为 $m$。若 $m \ge T/\tau$，则可以实现流水线存取。

### 4.3 高速缓冲存储器 (Cache)

#### 4.3.1 概述

Cache（高速缓冲存储器）主要解决CPU和主存速度不匹配的问题。

**1. Cache的工作原理**

*   程序访问的局部性原理
    * **时间局部性**: 当一个存储单元被访问时，它在未来可能会被多次访问（循环程序、子程序）。
    * **空间局部性**: 当一个存储单元被访问时，其附近的存储单元也可能将被访问（指令、数据通常在主存中顺序存放）。
*   将CPU近期要用的指令和数据提前从主存送到Cache，使得CPU可以不用访问主存来获取所需的指令和数据
    * **时间局部性**: 将当前访问的存储字放入Cache
    * **空间局部性**: 将当前访问的存储字的相邻存储字放入Cache
    * **主存和Cache间以字块为单位进行信息传递**
*   主存的编址
    *   由 $2^n$ 个存储字组成，每个字有n位地址。
    *   将主存分成若干块，每块包含相同数量的存储字。
    *   主存地址分为两段：高$m$位表示主存的块地址，低$b$位表示块内地址
    *   主存块数 $M = 2^m$，块长（块内字数） $B = 2^b$
*   缓存的编址
    *   将缓存分成若干块，每块包含相同数量的存储字，且与主存块长相等
    *   缓存地址分为两段：高$c$位表示缓存的块地址，低$b$位表示块内地址。
    *   缓存块数 $C = 2^c$，块长（块内字数） $B = 2^b$
*   主存和缓存的编址
    *   主存和缓存块的大小相同
    *   主存和缓存间按整个字块为单位进行信息传递，字块内对应存储字的块内地址完全相同
    *   用**标记**记录与该缓存块建立了对应关系的主存块的主存字块标记

![图 4.49 Cache-主存存储空间的基本结构](/img/post_article/计算机组成原理/4-49.png)

**2. 命中率公式**
命中率 ($h$) 是衡量Cache效率的核心指标。
*   **定义**：CPU访问的信息在Cache中找到的概率。
*   **公式**：
    $$ h = \frac{N_c}{N_c + N_m} $$
    *   $N_c$：访问Cache命中的次数。
    *   $N_m$：访问主存的次数（即Cache未命中）。
*   **平均访问时间 ($t_a$)**：
    $$ t_a = h \times t_c + (1 - h) \times t_m $$
    *   $t_c$：命中时的Cache访问时间。
    *   $t_m$：未命中时的主存访问时间。
*   **访问效率 ($e$)**：
    $$ e = \frac{t_c}{t_a} \times 100\% $$
    *   *理解*：效率越高，说明平均访问时间越接近Cache的访问时间。

**3. Cache的基本结构（4大模块详解）**

![图 4.50 Cache的基本结构原理框图](/img/post_article/计算机组成原理/4-50.png)

*   **(1) Cache 存储体**
    *   **构成**：由高速的SRAM芯片组成。
    *   **单位**：以**块**为单位进行组织。Cache中的块大小与主存中的块大小相同。
    *   **作用**：存放从主存调入的指令和数据。

*   **(2) 地址映射变换机构**
    *   **作用**：将CPU发出的主存地址，转换为Cache地址。
    *   **原理**：因为CPU只认识主存地址，不知道数据在Cache里的哪个位置。该机构通过查找**标记 (Tag)**，判断数据是否在Cache中（命中）。
    *   **结果**：如果命中，给出Cache地址；如果不命中，启动替换机构。

*   **(3) 替换机构**
    *   **作用**：当Cache满了，又需要调入新块时，决定踢走哪一块。
    *   **策略**：由替换算法决定（如LRU近期最少使用算法、FIFO先进先出算法）。
    *   **直接映射的特殊性**：直接映射不需要替换策略，因为位置是固定的，满了只能踢走原来那个。

*   **(4) Cache的读写控制电路**
    *   **作用**：控制数据的流动和一致性维护。
    *   **读操作**：命中则直接读Cache；未命中则读主存并调入Cache。
    *   **写操作**：需要解决Cache和主存内容不一致的问题（写直达法、写回法）。
        *   写直达法（Write-through）：写操作时数据既写入Cache又写入主存。能随时保证主存和Cache的数据始终一致，但增加了访存次数。
        *   写回法（Write-back）：写操作时只把数据写入Cache而不写入主存，但当Cache数据被替换出去时才写回主存。速度快，但增加了Cache复杂性。

![图 4.51 Cache的读数操作流程](/img/post_article/计算机组成原理/4-51.png)

**4. Cache的改进（简单介绍）**
为了进一步提升性能，现代Cache进行了改进：
*   **增加级数**：出现**片内Cache (L1)** 和 **片外Cache (L2)**，甚至L3。L1速度最快，L2容量稍大。
*   **分立缓存**：将**指令Cache**和**数据Cache**分开。
    *   *原因*：在流水线处理器中，取指令和取数据可能同时进行。分开可以避免资源冲突，提高并行度。

#### 4.3.2 Cache-主存地址映射

把主存的块放到Cache的哪里？有三种方式：

**1. 直接映射 (Direct Mapping)**
*   **规则**：$i = j$ $mod$ $C$ （ $i$ 是缓存块号，$j$ 是主存块号，$C$ 是总缓存块数，$C = 2^c$）
*   **地址结构**：主存字块标记（$t$ 位） + Cache字块地址（$c$ 位） + 字块内地址（$b$ 位）。
*   **优点**：硬件简单，成本低。
*   **缺点**：不够灵活，容易冲突（即便Cache其他地方空着，只要对应的位置被占了，就得替换）。

![图 4.54 直接映射](/img/post_article/计算机组成原理/4-54.png)

**2. 全相联映射 (Fully Associative Mapping)**
*   **规则**：主存的块可以放到Cache的**任何**位置。
*   **地址结构**：主存字块标记（$m=t+c$ 位） + 字块内地址（$b$ 位）。
*   **优点**：非常灵活，冲突少，命中率高。
*   **缺点**：比较电路极其复杂（因为要跟Cache里所有的标记比较），成本高，速度慢。

![图 4.55 全相联映射](/img/post_article/计算机组成原理/4-55.png)

**3. 组相联映射 (Set Associative Mapping)**
*   **规则**：$i = j \mod Q$ （ $i$ 是缓存组号，$j$ 是主存块号，$Q$ 是缓存组数）总缓存块数: $C = 2^c$，每组缓存块数: $R = 2^r$，缓存组数: $Q = 2^{c-r}$。
*   **地址结构**：主存字块标记（$s=t+r$ 位） + 组地址（$q=c-r$ 位） + 字块内地址（$b$ 位）。
*   **理解**：接近全相联的命中率，接近直接映射的简单结构。现代计算机多用此方式。

![图 4.56 组相联映射](/img/post_article/计算机组成原理/4-56.png)

> *   **描述**：分别展示了三种映射方式的连线逻辑。直接映射是多对一；全相联是多对多；组相联是组间多对一，组内多对多。

#### 4.3.3 替换策略

当Cache满了，新块要进来，旧块必须腾地方。踢谁走？

1.  **先进先出 (FIFO)**：谁先来的踢谁。简单，但可能踢走常用的数据（比如循环体）。
2.  **近期最少使用 (LRU)**：踢走最久没被访问过的。利用了局部性原理，命中率高，但硬件稍复杂。
3.  **随机法 (RAND)**：随便踢一个。简单，但命中率无法保证。

### 4.4 辅助存储器

#### 4.4.1 概述

辅存（外存）特点：不直接与CPU交换信息；容量大、价格低、非易失。

#### 4.4.2 磁记录原理和记录方式

*   **原理**：
    *   **写**：电流 $\rightarrow$ 磁头 $\rightarrow$ 磁场 $\rightarrow$ 磁层磁化。
    *   **读**：磁层运动 $\rightarrow$ 切割磁力线 $\rightarrow$ 感应电流。
*   **编码方式**（将0/1变成电流波形）：
    *   **NRZ (不归零制)**：磁头电流方向代表0/1。
    *   **NRZ1 (见1就翻)**：遇到1电流翻转，遇到0不变。
    *   **PM (调相制)**：每一位中间都有跳变。方向不同代表0/1。自带同步信号（自同步）。
    *   **FM (调频制)**：每一位开始都跳变，中间跳变表示1，不跳变表示0。

#### 4.4.3 硬磁盘存储器

*   **结构**：
    *   **盘片**：存储数据。
    *   **磁头**：读写数据。悬浮在盘面上（温切斯特技术，密封）。
    *   **磁道**：同心圆。
    *   **柱面**：所有盘片相同半径的磁道组成一个柱面。
    *   **扇区**：磁道被分为若干扇区。
*   **存取时间**（重要）：
    *   **寻道时间**：磁头移动到指定磁道（最慢，机械运动）。
    *   **旋转延迟时间**：等待扇区转到磁头下（平均为转半圈的时间）。
    *   **传输时间**：读写数据的时间。
*   **技术指标**：记录密度（道密度/位密度）、存储容量、平均寻址时间、数据传输率。

#### 4.4.4 软磁盘存储器

接触式读写，速度慢，容量小，已淘汰。

#### 4.4.5 磁带存储器

串行存取（必须顺序查找），适合大容量备份。

#### 4.4.6 循环冗余校验 (CRC)

*   **用途**：磁盘数据校验。
*   **原理**：利用生成多项式 $G(x)$ 进行模2除法（异或运算）。余数为0则无错。

#### 4.4.7 光盘存储器

*   **CD-ROM**：只读。压模制成。
*   **WORM**：写一次读多次。
*   **可擦写光盘**：利用热磁效应或相变原理，可重复读写。

## 第5章 输入输出系统

### 5.1 概述

输入输出（I/O）系统是计算机硬件系统的第三个关键部分，负责处理主机与外部世界的信息交换。

#### 5.1.1 输入输出系统的发展概况

I/O系统的发展经历了从简单到复杂、从CPU高度干预到独立处理的过程，大致可分为4个阶段：

1.  **早期阶段**：
    *   **特点**：I/O设备与主存交换信息都必须**通过CPU**。
    *   **缺点**：
        *   每个设备都有独立的逻辑电路，线路散乱。
        *   **串行工作**：I/O与CPU串行，I/O工作时CPU必须停止运算进行控制，极浪费时间。
        *   **扩展困难**：设备与CPU控制器紧密耦合，增减设备难。

2.  **接口模块和DMA阶段**：
    *   **接口模块**：I/O设备通过**接口**挂到总线上。
        *   接口内有数据通路和控制通路，起到缓冲、串并转换、传递控制命令等作用。
        *   实现了CPU与I/O设备**并行工作**（设备准备数据时，CPU可执行程序）。
        *   **局限**：数据交换时（如中断响应后）仍需CPU暂停现行程序参与。
    *   **DMA (直接存储器存取) 阶段**：
        *   **特点**：I/O设备与主存之间有一条**直接数据通路**。
        *   **优点**：数据交换不经过CPU，CPU资源利用率进一步提高。

![图 5.2 I/O 设备通过接口与主机交换信息](/img/post_article/计算机组成原理/5-2.png)

3.  **具有通道结构的阶段**：
    *   **背景**：在大中型机中，I/O设备繁多，若都配专用DMA接口会增加成本且控制复杂。
    *   **通道**：一种**具有特殊功能的处理器**（从属于CPU）。
        *   有专用的**通道指令**（通道控制字 CCW）。
        *   可以独立执行通道程序，管理I/O设备与主存交换信息。
    *   **优点**：CPU只需启动通道，后续工作由通道完成，极大提高了CPU效率。

4.  **具有I/O处理机的阶段**：
    *   **I/O处理机 (PPU)**：基本**独立于主机**工作。
    *   **功能**：不仅完成I/O控制，还能进行码制变换、格式处理、检错纠错等。
    *   **优点**：I/O系统具有更大的独立性，并行性更高。

#### 5.1.2 输入输出系统的组成

I/O系统由**I/O软件**和**I/O硬件**两部分组成。

**1. I/O软件**
*   **任务**：程序/数据输入、结果输出、系统协调。
*   **I/O指令**：CPU指令系统的一部分。
    *   **格式**：[ 操作码 ] [ 命令码 ] [ 设备码 ]
        *   **操作码**：识别是否为I/O指令。
        *   **命令码**：做什么操作（如读、写、状态测试、控制操作）。
        *   **设备码**：对哪个设备操作（相当于设备地址）。
*   **通道指令 (CCW)**：
    *   **区别**：通道指令是通道执行的，I/O指令是CPU执行的。
    *   **作用**：指明数据首地址、传送字节数、操作命令等。
    *   **通道程序**：由通道指令组成，存放在主存中。

**2. I/O硬件**
*   包括**接口模块**（含数据通路、控制通路、逻辑电路）和**I/O设备**。
*   **连接方式**：
    *   **辐射式**（早期）：每台设备一套控制线，连线多，扩展难。
    *   **总线式**（现代）：所有设备通过接口挂在总线上。

#### 5.1.3 I/O设备与主机的联系方式

**1. I/O设备编址方式**
*   **统一编址**（存储器映射I/O）：
    *   将I/O地址看作存储器地址的一部分。
    *   **优点**：无需专用I/O指令，访存指令即可操作I/O，指令集丰富。
    *   **缺点**：占用主存空间。
*   **不统一编址**（独立编址）：
    *   I/O地址和存储器地址分开。
    *   **优点**：不占用主存空间。
    *   **缺点**：需要专用的I/O指令。

**2. 设备寻址**
*   通过I/O指令中的**设备码**字段直接指出设备号。
*   接口电路中有设备选择电路来识别。

**3. 传送方式**
*   **并行传送**：同时传送多位信息，传输速度较快，适合近距离传输。
*   **串行传送**：一次只传送一位信息，传输速度较慢，适合远距离传输。

**4. 联络方式**（解决时序配合问题）
*   **立即响应方式**：接收到I/O指令时，立即响应，如指示灯的亮/灭。
*   **异步工作采用应答信号联络**：
    *   I/O设备与主机工作速度不匹配时，采用异步工作方式。
    *   I/O设备与CPU各自独立工作，出现联络信号时才准备交换信息。
    *   I/O设备接收数据时：
        *   I/O接口接收CPU发送的数据，并发出“Ready”信号。
        *   I/O设备从接口取出数据，并发出“Strobe”信号。
    *   I/O设备发送数据时
        *   I/O设备向接口送数据，并发出“Strobe”信号。
        *   CPU取走数据，接口向I/O设备发送“Ready”信号，通知其可继续送数据。

![图 5.6 异步并行“应答”联络方式](/img/post_article/计算机组成原理/5-6.png)

*   **同步工作采用同步时标联络**：要求工作速度完全同步，配有专用时钟。

**5. I/O 设备与主机的连接方式**

*   **辐射式连接（分散连接）**：
    *   每台设备都配有一套控制线路和一组信号线。
    *   不便于增删设备。
    *   设备可移植性差。
*   **总线连接**：
    *   I/O设备通过标准接口和一组总线和主机连接。
    *   便于增删设备。
    *   设备可移植性强。

#### 5.1.4 I/O设备与主机信息传送的控制方式

主要介绍前三种：
1.  **程序查询方式**：
    *   从某一I/O设备读数据块到主存，等待I/O设备准备数据时，CPU一直处于踏步等待状态。
    *   CPU通过程序**不断查询**I/O设备是否准备就绪。
    *   **缺点**：CPU“踏步”等待，串行工作，效率低。

![图 5.9 程序查询方式流程](/img/post_article/计算机组成原理/5-9.png)

2.  **程序中断方式**：
    *   将I/O设备的工作分为两个阶段
        *   数据/自身准备阶段
        *   与主机交换信息阶段
    *   I/O设备自身准备阶段，CPU 不进行查询
    *   I/O设备与主机交换信息阶段，CPU 暂停现行程序，为I/O设备服务
    *   **流程**：发出启动设备的指令以后，CPU继续执行原来的程序，当外部设备准备好以后，向CPU提出一个中断请求，让CPU停止对当前程序的执行，转而和I/O设备进行数据交换。
    *   **优点**：消除了“踏步”，实现了CPU与I/O**并行工作**。
    *   **缺点**：每次传送都需要保护/恢复现场，开销大，不适合高速大数据传送。

![图 5.10 程序中断方式示意图](/img/post_article/计算机组成原理/5-10.png)

![图 5.11 程序中断方式流程](/img/post_article/计算机组成原理/5-11.png)

3.  **DMA方式** (直接存储器存取)：
    *   主存与I/O之间建立**直接数据通路**。
    *   主存和 I/O可通过DMA控制器直接进行数据交换，不中断现行程序，不需CPU参与。
    *   采用周期挪用（周期窃取）的方式
        *   若DMA和CPU同时访问主存，DMA优先占有总线。
        *   窃取的时间一般为一个存取周期，称为窃取/挪用周期。
        *   窃取周期内，CPU不能使用总线访问主存，但尚能做内部操作（如乘法运算）。
    *   **CPU 和 I/O 并行工作**：通过指令预取，可加强CPU 和 I/O 在窃取周期内工作的并行性。
    *   **优点**：不需要CPU暂停现行程序（只需挪用存取周期），适合**高速、成组**数据传送。

4.  **三种方式的 CPU 工作效率比较**：
    *   **程序查询方式**：
        *   CPU执行到一条I/O指令后，启动I/O。
        *   I/O设备在进行自身准备时，CPU一直在查询等待。
        *   直到数据传输完成，CPU才继续执行原程序。
    *   **程序中断方式**：
        *   CPU执行到一条I/O指令后，启动I/O。
        *   启动I/O后，CPU接着执行原程序，I/O进行自身准备。
        *   I/O准备完成，发出中断请求，CPU才会在某一指令的执行周期结束后，响应中断。
    *   **DMA方式**：
        *   CPU执行到一条I/O指令后，启动I/O。
        *   启动I/O后，CPU接着执行原程序，I/O进行自身准备。
        *   I/O准备完成，窃取一个/多个存取周期，在DMA控制器的控制下，完成一个字或多个字的信息交换。
        *   在窃取周期内，CPU仍可执行不访问主存的操作。

![图 5.12 三种方式的CPU工作效率比较](/img/post_article/计算机组成原理/5-12.png)

### 5.2 I/O 设备

#### 5.2.1 概述
*   I/O设备（外设）大致分为三类：
    1.  **人机交互设备**：键盘、鼠标、显示器、打印机等。
    2.  **计算机信息存储设备**：磁盘、光盘、磁带（辅存）。
    3.  **机-机通信设备**：Modem等。

#### 5.2.2 输入设备
*   **键盘**：最普遍。分为编码键盘（硬件产生编码）和非编码键盘（软件扫描）。
*   **鼠标**：机械式、光电式。
*   **触摸屏**：电阻式、电容式等。

#### 5.2.3 输出设备
**1. 显示设备**
*   **CRT显示器**：
    *   **原理**：电子枪发射电子束轰击荧光屏。
    *   **扫描方式**：
        *   **光栅扫描**：电子束按轨迹扫描（电视原理），需不断刷新。
        *   **随机扫描**：电子束像画笔一样画图（矢量法）。
    *   **字符显示器**：
        *   **VRAM (刷新存储器)**：存放字符的ASCII码。容量 = 行 × 列 × 属性位。
        *   **字符发生器 (ROM)**：将ASCII码转换为点阵信息（如7×9点阵）。
        *   **CRT控制器**：控制扫描时序和同步。
    *   **图形显示器**：主观图像（点线面组合）。
    *   **图像显示器**：客观图像（照片）。需**灰度**、**真彩色**等技术。

**2. 打印设备**
*   **击打式**：
    *   **点阵针式打印机**：利用钢针撞击色带。结构简单，可打多层，但噪声大、质量一般。
*   **非击打式**：
    *   **激光打印机**：激光扫描+电子照相技术。质量好、速度快、无噪声。页式输出。
    *   **喷墨打印机**：喷射墨水。印字质量接近激光，价格便宜。

#### 5.2.4 其他 I/O 设备

除了人机交互设备（键盘、鼠标、显示器、打印机），还有以下重要设备：

1.  **终端设备 (Terminal)**
    *   由显示器和键盘组成的一套独立完整的I/O设备。
    *   通过标准接口连接到远离主机的地方（远程）。
    *   功能比普通显示器复杂，具备显示控制、存储、键盘管理及通信控制能力。

2.  **A/D 和 D/A 转换器** (用于过程控制)
    *   **A/D (模拟/数字转换器)**：将模拟量（电压、温度等）转换为数字量。属于**输入设备**。
    *   **D/A (数字/模拟转换器)**：将计算机输出的数字量转换为模拟量（控制电机转速等）。属于**输出设备**。

3.  **汉字处理设备**
    *   **汉字编码**：
        *   **输入码**：用于输入（拼音、五笔）。
        *   **内码**：计算机内部存储、处理汉字用的代码（如GB2312）。通常用两个字节表示，最高位为1（区别于ASCII）。
        *   **字形码**：用于显示和打印（点阵信息）。
    *   **汉字输出**：需要**字库**支持，将内码转换为字形码（点阵）输出。

#### 5.2.5 多媒体技术

1.  **定义**：计算机技术与声、像技术的结合。将文字、图形、图像、音频、视频等多种媒体信息综合处理。
2.  **关键技术**：
    *   **数据压缩/解压缩**：图像和视频数据量极大，必须压缩（如JPEG, MPEG标准）。
    *   **专用芯片**：用于实时的信号处理。
    *   **大容量存储**：如大容量硬盘、光盘。
    *   **多媒体软件**：驱动程序、创作工具、应用软件。

### 5.3 I/O 接口

#### 5.3.1 概述
*   **接口 (Interface)**：主机与I/O设备之间的硬件电路+软件控制。
*   **为什么要设置接口？**
    1.  实现**设备选择**（选址）。
    2.  实现**速度匹配**（数据缓冲）。
    3.  实现**数据格式转换**（串-并）。
    4.  实现**电平转换**。
    5.  传送**控制命令**。
    6.  监视**设备状态**。
*   **端口 (Port)**：接口中的寄存器（数据端口、控制端口、状态端口）。

#### 5.3.2 接口的功能和组成
*   **总线连接方式**：数据线、设备选择线、命令线、状态线。
*   **核心功能模块**：
    1.  **设备选择电路**：识别设备地址（选址）。
    2.  **命令寄存器/译码器**：存放/解析CPU命令。
    3.  **数据缓冲寄存器 (DBR)**：暂存数据，匹配速度。
    4.  **设备状态标记**：
        *   **D (完成触发器)**：D=1表示准备就绪。
        *   **B (工作触发器)**：B=1表示正在忙。
        *   **INTR (中断请求)**：向CPU发中断。
        *   **MASK (屏蔽)**：屏蔽中断。

#### 5.3.3 接口类型
*   按数据传送：并行接口、串行接口。
*   按功能灵活性：可编程接口、不可编程接口。
*   按通用性：通用接口、专用接口。
*   按控制方式：程序型接口、DMA型接口。

### 5.4 程序查询方式

#### 5.4.1 程序查询流程

程序查询方式的核心是 **CPU 不断地询问 I/O 设备：“你好了没？”**。整个过程是串行的。

**1. 核心思想**
CPU 暂时停止现行程序的执行，运行一段专门的**查询程序**。该程序不断读取 I/O 接口中的状态标记，直到设备准备就绪，才进行数据传送。

**2. 详细步骤**
假设要将数据从 I/O 设备读入 CPU：

*   **Step 1: 预置 (初始化)**
    *   **保存寄存器**：因为查询程序要用到 CPU 的寄存器，所以先把寄存器里原有的内容保存起来（如压入堆栈）。
    *   **设置计数器**：要传多少个数据？设置好计数值。
    *   **设置内存首址**：数据读进来放哪？设置好主存缓冲区的首地址。

*   **Step 2: 启动设备**
    *   CPU 向 I/O 接口发送“启动”指令（置位接口中的工作触发器 B，复位完成触发器 D）。

*   **Step 3: 循环查询 (踏步等待)**
    *   **读状态**：CPU 读取接口中的状态标记（通常是 D 标记）。
    *   **判断**：
        *   如果 **D=0** (未就绪)：CPU 跳转回“读状态”指令，**反复循环**。这一步被称为“踏步”或“忙等” (Busy Wait)，是查询方式效率低下的根源。
        *   如果 **D=1** (就绪)：跳出循环，进入下一步。

*   **Step 4: 数据传送**
    *   CPU 从接口的数据缓冲寄存器 (DBR) 中读取一个数据。
    *   将数据写入主存指定单元。

*   **Step 5: 修改参数**
    *   主存地址加 1。
    *   计数器减 1。

*   **Step 6: 判断结束**
    *   检查计数器是否为 0。
    *   **不为 0**：说明还有数据没传完，返回 Step 2 或 Step 3（视具体设备是否需要重新启动）。
    *   **为 0**：传送结束。

*   **Step 7: 结束**
    *   恢复寄存器内容（出栈）。
    *   继续执行原来的主程序。

**3. 总结**
*   **优点**：硬件结构最简单，控制容易。
*   **缺点**：CPU 在设备准备期间处于“踏步”状态，**极大地浪费了 CPU 资源**，CPU 与 I/O 无法并行工作。

#### 5.4.2 程序查询方式的接口电路

为了配合上述流程，接口电路通常包含：
1.  **设备选择电路**：识别地址线上的设备号。
2.  **数据缓冲寄存器 (DBR)**：暂存数据。
3.  **状态标记**：
    *   **D (Done, 完成触发器)**：D=1 表示准备好。
    *   **B (Busy, 工作触发器)**：B=1 表示正在忙。
4.  **控制逻辑**：接收 CPU 的启动命令，置位 B，复位 D；设备工作结束后，置位 D，复位 B。

### 5.5 程序中断方式

#### 5.5.1 中断的概念
CPU在执行程序时，出现异常或特殊请求，暂停现行程序，转去处理该请求，处理完后返回原断点继续执行。

#### 5.5.2 I/O中断的产生
为了解决程序查询方式中CPU“踏步”等待的问题。CPU启动设备后继续执行主程序，设备准备好后主动发**中断请求**。

#### 5.5.3 程序中断方式的接口电路
为了配合中断，接口需增加：
1.  **中断请求触发器 (INTR)** 和 **屏蔽触发器 (MASK)**。
2.  **排队器**：解决多个中断源同时请求的判优问题。
    *   **硬件实现**：链式排队电路（分散在接口）或集中在CPU内。
3.  **中断向量地址形成部件**（设备编码器）：
    *   **硬件向量法**：由硬件产生**向量地址**，该地址指向中断服务程序的入口地址（或跳转指令）。

#### 5.5.4 I/O中断处理过程
1.  **CPU响应中断的条件**：
    *   允许中断触发器 **EINT = 1**（开中断）。
    *   指令执行阶段结束时刻。
2.  **处理流程**：
    *   **中断请求**：设备发INTR。
    *   **中断判优**：排队器决定响应哪个。
    *   **中断响应**：
        *   CPU发中断响应信号 **INTA**。
        *   **关中断**（置EINT=0，防止更高优先级打断，或在单重中断中防止同级打断）。
        *   **保存断点**（PC推入堆栈）。
        *   获取**向量地址**，转入中断服务程序。
    *   **中断服务**：
        *   **保护现场**（PUSH寄存器）。
        *   **设备服务**（真正的I/O数据传送）。
        *   **恢复现场**（POP寄存器）。
        *   **开中断**。
        *   **中断返回**（IRET，恢复PC）。

*   **单重中断 vs 多重中断**：
    *   **单重中断**：处理中断时不能被新的中断打断。服务程序执行完才开中断。
    *   **多重中断（中断嵌套）**：允许级别更高的中断打断低级别中断。保护现场后**立即开中断**。

#### 5.5.5 中断服务程序的流程

中断服务程序是 CPU 响应中断后执行的一段程序，其流程一般分为四大部分：

1.  **保护现场**
    *   **含义**：保存当前 CPU 的状态，以便中断处理完后能回得来。
    *   **内容**：
        *   **程序断点** (PC)：通常由**硬件**（中断隐指令）自动保存到堆栈。
        *   **通用寄存器 & 状态寄存器**：通常由**软件**（服务程序开头的 PUSH 指令）保存。

2.  **中断服务 (核心部分)**
    *   执行真正的 I/O 操作。例如：从接口读取数据放入 CPU 寄存器，再写入主存；或者将主存数据送入打印机接口。
    *   *注*：如果是**多重中断**，通常在此阶段之前或之中执行“开中断”指令，允许更高优先级的请求打断。

3.  **恢复现场**
    *   在服务程序结束前，将保存在堆栈中的寄存器内容弹回 (POP)，使 CPU 恢复到中断前的状态。

4.  **中断返回**
    *   执行中断返回指令 (如 IRET)。
    *   该指令通常包含两个动作：
        *   返回断点（恢复 PC）。
        *   开中断（允许响应新的中断）。

### 5.6 DMA 方式

#### 5.6.1 DMA 方式的特点
*   **直接存储器存取**：主存与I/O设备间建立直接数据通路。
*   **不经过CPU**：数据不经过CPU寄存器（ACC等）。
*   **不需中断服务程序**：仅在传送开始（预处理）和结束（后处理）时需要CPU干预。
*   **三种DMA传送方法**：
    1.  **停止CPU访问主存**：DMA工作时，CPU完全停止访存。
    2.  **周期挪用（周期窃取）**：
        *   当I/O有请求时，挪用一个**存取周期**。
        *   若CPU此时不访存，无冲突。
        *   若CPU正在访存，等待CPU存取周期结束。
        *   若同时请求，**I/O优先**（因为I/O数据可能丢失）。
    3.  **DMA与CPU交替访问**：适用于CPU工作周期比主存存取周期长的情况。

#### 5.6.2 DMA 接口的功能和组成
*   **功能**：
    1.  向CPU申请DMA。
    2.  处理总线控制权转交。
    3.  管理总线，控制传送。
    4.  修改地址和计数器。
*   **组成**：
    1.  **主存地址寄存器 (AR)**：存放主存地址。
    2.  **字计数器 (WC)**：记录传送字数。
    3.  **数据缓冲寄存器 (BR)**。
    4.  **DMA控制逻辑**。
    5.  **中断机构**：用于传送结束后的处理。
    6.  **设备地址寄存器 (DAR)**。

#### 5.6.3 DMA 的工作过程
1.  **预处理**：CPU执行几条指令，初始化DMA（设置AR, WC, DAR，启动设备）。
2.  **数据传送**：
    *   设备准备好字 -> 发DREQ（DMA请求）。
    *   DMA回DACK，发HRQ（总线请求）给CPU。
    *   CPU回HLDA（总线响应），让出总线。
    *   DMA控制数据直接在设备和主存间传送。
    *   修改AR（+1），修改WC（-1）。
    *   循环直到WC=0。
3.  **后处理**：
    *   WC=0（溢出），DMA发中断请求。
    *   CPU执行中断服务程序，做结束处理（校验、测试等）。

*   **DMA与中断方式的区别**：
    *   中断是**程序**切换，DMA是**硬件**占用总线。
    *   中断响应在**指令**执行结束，DMA响应在**存取周期**结束。
    *   中断处理异常和I/O，DMA只处理I/O数据传送。
    *   DMA优先级高于中断。

#### 5.6.4 DMA 接口的类型

根据 DMA 接口连接设备的方式和逻辑，主要分为两类：

1.  **选择型 DMA 接口 (Selector Mode)**
    *   **物理连接**：物理上可以连接多个设备（如磁盘、磁带）。
    *   **逻辑工作**：在**某一个时间段内，只能为一个设备服务**。
    *   **特点**：一旦选中某个设备，该设备就独占 DMA 接口，直到一批数据传送完毕。
    *   **适用**：**高速**设备（因为高速设备传输时不能被打断）。

2.  **多路型 DMA 接口 (Multiplexer Mode)**
    *   **物理连接**：连接多个设备。
    *   **逻辑工作**：不仅在物理上连接多个，而且在逻辑上允许这些设备**同时工作**。
    *   **原理**：各设备通过**字节交叉**（分时）的方式复用 DMA 接口。即设备 A 传一个字节，设备 B 传一个字节...
    *   **适用**：**中、低速**设备（数据准备时间较长，DMA 接口有空闲时间服务其他设备）。